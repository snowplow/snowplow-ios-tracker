name: Build

on: [push]

jobs:
  test_framework:
    name: "Framework (iOS ${{ matrix.version.ios }})"
    runs-on: macos-${{ matrix.version.macos }}
    env:
      DEVELOPER_DIR: /Applications/Xcode_${{ matrix.version.xcode }}.app/Contents/Developer
      
    strategy:
      fail-fast: false
      matrix:
        version:
          - {ios: 15.5, iphone: iPhone 12 Pro, watchos: 8.5, watch: Apple Watch Series 5 - 44mm, macos: '12', xcode: 13.4}
          - {ios: 14.4, iphone: iPhone 8, watchos: 7.2, watch: Apple Watch Series 4 - 40mm, macos: '11', xcode: 12.4}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Test
        env:
          IOS: ${{ matrix.version.ios }}
          WATCHOS: ${{ matrix.version.watchos }}
          IPHONE: ${{ matrix.version.iphone }}
          WATCH: ${{ matrix.version.watch }}
        run: |
          . .scripts/setup.sh
          .scripts/test_framework.sh "${BUILD_PROJECT_LIB}" "${BUILD_DEST_IOS}" "${BUILD_SCHEME_LIB_IOS}" "${BUILD_DEST_WATCH}" "${BUILD_SCHEME_LIB_WATCH}"  

  build_objc_demo_app:
    name: "ObjC demo (iOS ${{ matrix.version.ios }})"
    needs: test_framework
    runs-on: macos-${{ matrix.version.macos }}
    env:
      DEVELOPER_DIR: /Applications/Xcode_${{ matrix.version.xcode }}.app/Contents/Developer

    strategy:
      fail-fast: false
      matrix:
        version:
          - {ios: 15.5, iphone: iPhone 12 Pro, watchos: 8.5, watch: Apple Watch Series 5 - 44mm, macos: '12', xcode: 13.4}
          - {ios: 14.4, iphone: iPhone 8, watchos: 7.2, watch: Apple Watch Series 4 - 40mm, macos: '11', xcode: 12.4}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get example branch name
        id: example_branch
        run: |
          DEMO_BRANCH=$(cat .scripts/demo_apps_branch_name)
          echo ::set-output name=name::${DEMO_BRANCH}
      - name: Checkout demo app
        uses: actions/checkout@v2
        with:
          repository: snowplow-incubator/snowplow-swift-ios-tracker-examples
          ref: ${{ steps.example_branch.outputs.name }}
          path: examples

      - name: Build
        env:
          IOS: ${{ matrix.version.ios }}
          WATCHOS: ${{ matrix.version.watchos }}
          IPHONE: ${{ matrix.version.iphone }}
          WATCH: ${{ matrix.version.watch }}
        run: |
          cd examples/demo/ 
          . .scripts/setup.sh
          .scripts/test_ios_demo.sh -app SnowplowObjCDemo -podfile Podfile -ios "${BUILD_WORKSPACE_OBJC_DEMO}" "${BUILD_DEST_IOS}" "${BUILD_SCHEME_OBJC_DEMO}"

  build_swift_cocoapods_demo_app:
    name: "Swift demo (Cocoapods) (iOS ${{ matrix.version.ios }})"
    needs: test_framework
    runs-on: macos-${{ matrix.version.macos }}
    env:
      DEVELOPER_DIR: /Applications/Xcode_${{ matrix.version.xcode }}.app/Contents/Developer

    strategy:
      fail-fast: false
      matrix:
        version:
          - {ios: '14.4', iphone: iPhone 12 Pro, watchos: '7.2', watch: Apple Watch Series 5 - 44mm, macos: '11', xcode: 12.4}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get example branch name
        id: example_branch
        run: |
          DEMO_BRANCH=$(cat .scripts/demo_apps_branch_name)
          echo ::set-output name=name::${DEMO_BRANCH}
      - name: Checkout demo app
        uses: actions/checkout@v2
        with:
          repository: snowplow-incubator/snowplow-swift-ios-tracker-examples
          ref: ${{ steps.example_branch.outputs.name }}
          path: examples

      - name: Build
        env:
          IOS: ${{ matrix.version.ios }}
          WATCHOS: ${{ matrix.version.watchos }}
          IPHONE: ${{ matrix.version.iphone }}
          WATCH: ${{ matrix.version.watch }}
        run: |
          cd examples/demo/ 
          . .scripts/setup.sh
          .scripts/test_ios_demo.sh -app SnowplowSwiftCocoapodsDemo -podfile Podfile -ios "${BUILD_WORKSPACE_SWIFT_DEMO}" "${BUILD_DEST_IOS}" "${BUILD_SCHEME_SWIFT_DEMO_IOS}" -watch "${BUILD_DEST_PAIRED}" "${BUILD_SCHEME_SWIFT_DEMO_WATCH}"

  build_swift_spm_demo_app:
    name: "Swift demo (SPM) (iOS ${{ matrix.version.ios }})"
    needs: test_framework
    runs-on: macos-${{ matrix.version.macos }}
    env:
      DEVELOPER_DIR: /Applications/Xcode_${{ matrix.version.xcode }}.app/Contents/Developer

    strategy:
      fail-fast: false
      matrix:
        version:
          - {ios: '14.4', iphone: iPhone 11 Pro, watchos: '7.2', watch: Apple Watch Series 5 - 44mm, macos: '11', xcode: 12.4}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get example branch name
        id: example_branch
        run: |
          DEMO_BRANCH=$(cat .scripts/demo_apps_branch_name)
          echo ::set-output name=name::${DEMO_BRANCH}

      - name: Get branch name
        id: branch
        run: |
          # Set git branch or git tag as slug
          if [[ ${GITHUB_REF} =~ ^refs\/tags\/ ]]; then
            GIT_BRANCH=master
          else
            if [ -n "${GITHUB_HEAD_REF}" ]; then
              GIT_BRANCH="${GITHUB_HEAD_REF}"
            else
              GIT_BRANCH="${GITHUB_REF/refs\/heads\//}"
            fi
          fi
          echo ::set-output name=name::${GIT_BRANCH}

      - name: Checkout demo app
        uses: actions/checkout@v2
        with:
          repository: snowplow-incubator/snowplow-swift-ios-tracker-examples
          ref: ${{ steps.example_branch.outputs.name }}
          path: examples

      - name: Build
        env:
          IOS: ${{ matrix.version.ios }}
          WATCHOS: ${{ matrix.version.watchos }}
          IPHONE: ${{ matrix.version.iphone }}
          WATCH: ${{ matrix.version.watch }}
          BRANCH: ${{ steps.branch.outputs.name }}
        run: |
          cd examples/demo/
          . .scripts/setup.sh
          .scripts/test_ios_demo.sh -app SnowplowSwiftSPMDemo -spm ${BRANCH} -ios "${BUILD_WORKSPACE_SWIFT_SPM_DEMO}" "${BUILD_DEST_IOS}" "${BUILD_SCHEME_SWIFT_SPM_DEMO_IOS}"
